<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="‡∏à‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Prompt:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #f59e0b;
            --primary-light: #fbbf24;
            --primary-dark: #d97706;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-app: #f1f5f9;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --card-bg: rgba(255, 255, 255, 0.85);
            --nav-bg: rgba(255, 255, 255, 0.8);
            --radius-lg: 24px;
            --radius-md: 16px;
            --shadow-soft: 0 10px 25px -5px rgba(0, 0, 0, 0.08);
            --shadow-premium: 0 20px 25px -5px rgba(245, 158, 11, 0.15);
            --modal-bg: #ffffff;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --header-bg: rgba(255, 255, 255, 0.7);
        }

        body.dark-mode {
            --bg-app: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.7);
            --nav-bg: rgba(15, 23, 42, 0.8);
            --modal-bg: #1e293b;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: #1e293b;
            --header-bg: rgba(15, 23, 42, 0.7);
            --shadow-soft: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', 'Prompt', sans-serif;
            background-color: var(--bg-app);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.05) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            overflow-x: hidden;
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            padding-bottom: 110px;
            position: relative;
            background: var(--card-bg);
            /* ‡∏¢‡πâ‡∏≤‡∏¢ filter ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ position: fixed ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á */
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.08);
        }

        .page-header {
            padding: 35px 24px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--header-bg);
            backdrop-filter: blur(15px);
            z-index: 50;
            border-bottom: 1px solid var(--border-color);
        }

        .user-info h1 {
            font-size: 1.7rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--text-main), var(--primary-dark));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .profile-pic {
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .profile-pic:hover {
            transform: scale(1.05);
        }

        .profile-pic img {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: var(--shadow-premium);
        }

        .sheets-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: #0f9d58;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .sheets-badge i {
            width: 12px;
            height: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 10px 24px 24px;
        }

        .stat-card {
            padding: 20px;
            border-radius: var(--radius-lg);
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
            box-shadow: var(--shadow-premium);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .stat-card .value {
            font-size: 1.4rem;
            font-weight: 800;
            margin: 8px 0;
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 700;
            display: inline-block;
            margin-top: 4px;
        }

        .status-paid {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-unpaid {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        body.dark-mode .status-paid {
            background: rgba(16, 185, 129, 0.3);
            color: #34d399;
        }

        body.dark-mode .status-unpaid {
            background: rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .section-title {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title h3 {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            padding: 18px;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            margin: 0 24px 14px;
            box-shadow: var(--shadow-soft);
        }

        .icon-box {
            width: 50px;
            height: 50px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 18px;
            font-size: 1.2rem;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .item-info {
            flex: 1;
        }

        .item-amount {
            text-align: right;
        }

        .item-amount .price {
            font-weight: 800;
            color: var(--text-main);
        }

        .room-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding: 0 24px;
        }

        .room-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .room-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .room-card.occupied::before {
            background: var(--primary);
            opacity: 1;
        }

        .room-card.vacant::before {
            background: var(--success);
            opacity: 1;
        }

        .room-card:active {
            transform: scale(0.98);
        }

        .room-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .room-tag.vacant {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .room-tag.occupied {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .bottom-nav {
            position: fixed;
            bottom: 15px;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPhone ‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÜ */
            bottom: calc(15px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 48px);
            max-width: 450px;
            background: var(--nav-bg);
            backdrop-filter: blur(22px);
            -webkit-backdrop-filter: blur(22px);
            height: 75px;
            border-radius: 28px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            z-index: 9999;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #94a3b8;
            flex: 1;
        }

        .nav-item.active {
            color: var(--primary);
            font-weight: 700;
        }

        .nav-item i {
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
        }

        .nav-item span {
            font-size: 0.75rem;
        }

        .page {
            display: none;
            transform: translateY(15px);
            transition: 0.4s;
        }

        .page.active {
            display: block;
            transform: translateY(0);
        }

        .billing-form {
            padding: 0 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 15px;
            border-radius: 18px;
            border: 1.5px solid rgba(226, 232, 240, 0.8);
            background: var(--input-bg);
            color: var(--text-main);
            font-family: inherit;
            font-size: 1rem;
        }

        .meter-grid {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 24px;
        }

        .meter-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 22px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }

        .meter-section h4 {
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-pair {
            display: flex;
            gap: 12px;
        }

        .input-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-container label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            padding-left: 5px;
        }

        .input-pair input {
            width: 100%;
            text-align: center !important;
            font-size: 1.3rem !important;
            font-weight: 800 !important;
            padding: 18px 5px !important;
            border-radius: 16px !important;
            background: var(--input-bg) !important;
            border: 1.5px solid var(--border-color) !important;
            color: var(--primary) !important;
        }

        .input-pair input:focus {
            background: var(--input-bg) !important;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1) !important;
            outline: none;
        }

        .btn-camera {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
            transition: all 0.2s;
            z-index: 5;
        }

        .btn-camera:active {
            transform: scale(0.9);
        }

        body.dark-mode .btn-camera {
            background: #1e293b;
        }

        /* Camera Modal Specific Styles */
        .camera-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 40%;
            border: 2px solid var(--primary);
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            pointer-events: none;
        }

        .camera-actions {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .ocr-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
        }

        .btn-capture {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 16px;
            font-weight: 700;
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary-large {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            border: none;
            padding: 20px;
            border-radius: 20px;
            font-size: 1.15rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow-premium);
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .btn-add {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            /* ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á */
            padding: 20px;
            overflow-y: auto;
            /* ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏¢‡∏≤‡∏ß */
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--modal-bg);
            border-radius: 32px;
            width: 100%;
            max-width: 400px;
            color: var(--text-main);
            margin: auto;
            /* ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏¢‡∏≤‡∏ß */
            position: relative;
            max-height: none;
            /* ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≠‡∏Å */
        }

        .receipt-card {
            padding: 35px;
            text-align: left;
            background: var(--modal-bg);
        }

        .receipt-header {
            border-bottom: 2px dashed #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .receipt-total {
            border-top: 2px solid var(--primary);
            padding-top: 20px;
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
        }

        .modal-actions {
            padding: 20px;
            background: var(--bg-app);
            display: flex;
            gap: 10px;
        }

        .modal-actions button {
            flex: 1;
            padding: 15px 5px;
            border-radius: 16px;
            border: none;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-receipt-action {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .btn-receipt-action:active {
            transform: scale(0.95);
            opacity: 0.9;
        }

        .btn-secondary-custom {
            background: rgba(245, 158, 11, 0.1);
            color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .theme-selector {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }

        .theme-btn {
            flex: 1;
            padding: 18px;
            border-radius: 20px;
            border: 2px solid transparent;
            background: var(--bg-app);
            color: var(--text-muted);
            font-weight: 700;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-btn i {
            width: 28px;
            height: 28px;
        }

        .theme-btn.active {
            background: var(--input-bg);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: var(--shadow-premium);
            transform: translateY(-2px);
        }

        .settings-card {
            background: var(--card-bg);
            margin: 0 24px 20px;
            padding: 24px;
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }

        .sync-status {
            margin-top: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Meter History Table Styles */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .history-table th {
            text-align: left;
            padding: 12px 8px;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 600;
        }

        .history-table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .history-row:last-child td {
            border-bottom: none;
        }

        .meter-val {
            font-weight: 700;
            color: var(--text-main);
        }

        .meter-diff {
            font-size: 0.7rem;
            color: var(--primary);
            font-weight: 600;
            background: rgba(99, 102, 241, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }

        /* PWA Install Banner */
        .install-banner {
            display: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            margin: 0 24px 20px;
            padding: 24px;
            border-radius: 24px;
            color: white;
            box-shadow: var(--shadow-premium);
            position: relative;
            overflow: hidden;
        }

        .install-banner h4 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .install-banner p {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .btn-install-now {
            background: white;
            color: var(--primary);
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .install-banner i.bg-icon {
            position: absolute;
            right: -20px;
            bottom: -20px;
            width: 100px;
            height: 100px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }

        @media print {

            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Modal ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà */
            body * {
                visibility: hidden;
            }

            #receipt-modal,
            #receipt-modal * {
                visibility: visible;
            }

            /* ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Modal ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
            #receipt-modal {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                visibility: visible !important;
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .modal-content {
                box-shadow: none !important;
                border: none !important;
                width: 100% !important;
                max-width: none !important;
                background: white !important;
                color: black !important;
            }

            .receipt-card {
                padding: 10px !important;
                color: black !important;
            }

            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå */
            .modal-actions {
                display: none !important;
            }

            /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå */
            .receipt-header {
                border-bottom: 2px dashed #000 !important;
                color: black !important;
            }

            .receipt-total {
                border-top: 2px solid #000 !important;
                color: black !important;
                font-size: 20pt !important;
            }

            .receipt-row {
                color: black !important;
                font-size: 14pt !important;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <main id="main-content">
            <!-- Dashboard -->
            <section id="dashboard" class="page active">
                <header class="page-header">
                    <div class="user-info">
                        <h1>‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</h1>
                        <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏û‡∏±‡∏Å & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î</p>
                    </div>
                    <div class="profile-pic" onclick="openGoogleSheets()" title="‡πÄ‡∏õ‡∏¥‡∏î Google Sheets">
                        <img src="icon.png" alt="Profile">
                        <div class="sheets-badge">
                            <i data-lucide="file-spreadsheet"></i>
                        </div>
                    </div>
                </header>
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <span class="label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</span>
                        <h2 class="value" id="stat-income">‡∏ø0</h2>
                    </div>
                    <div class="stat-card purple">
                        <span class="label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
                        <h2 class="value" id="stat-monthly">‡∏ø0</h2>
                    </div>
                    <div class="stat-card orange" style="grid-column: span 2;">
                        <span class="label">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏ß‡∏°</span>
                        <h2 class="value" id="stat-pending">‡∏ø0</h2>
                    </div>
                </div>
                <div class="section-title">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                </div>
                <div id="recent-transactions"></div>
            </section>

            <!-- Rooms -->
            <section id="rooms" class="page">
                <header class="page-header">
                    <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</h1>
                    <button class="btn-add" onclick="openAddRoom()"><i data-lucide="plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á</button>
                </header>
                <div class="room-grid" id="room-list" style="margin-top: 20px;"></div>
            </section>

            <!-- Billing -->
            <section id="billing" class="page">
                <header class="page-header">
                    <h1 id="billing-title">‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</h1>
                    <button id="cancel-edit-btn" onclick="cancelEditBill()" class="btn-secondary"
                        style="display:none; padding:8px 15px; border-radius:10px; font-size:0.8rem;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </header>
                <div class="billing-form">
                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏û.‡∏®.)</label>
                        <input type="date" id="bill-date">
                    </div>
                    <div class="form-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</label>
                        <select id="bill-room-select" onchange="updateBaseRent()"></select>
                    </div>
                    <div class="meter-grid">
                        <div class="meter-section" style="position: relative;">
                            <h4>üíß ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</h4>
                            <button class="btn-camera" onclick="openCamera('water-curr')" title="‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå">
                                <i data-lucide="camera"></i>
                            </button>
                            <div class="input-pair">
                                <div class="input-container">
                                    <label>‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô</label>
                                    <input type="number" id="water-prev" placeholder="0">
                                </div>
                                <div class="input-container">
                                    <label>‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ</label>
                                    <input type="number" id="water-curr" placeholder="0">
                                </div>
                            </div>
                        </div>
                        <div class="meter-section" style="position: relative;">
                            <h4>‚ö° ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</h4>
                            <button class="btn-camera" onclick="openCamera('elec-curr')" title="‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå">
                                <i data-lucide="camera"></i>
                            </button>
                            <div class="input-pair">
                                <div class="input-container">
                                    <label>‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô</label>
                                    <input type="number" id="elec-prev" placeholder="0">
                                </div>
                                <div class="input-container">
                                    <label>‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ</label>
                                    <input type="number" id="elec-curr" placeholder="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="text" id="base-rent" oninput="formatMoneyInput(this)" inputmode="numeric">
                    </div>
                    <button onclick="calculateBill()" class="btn-primary-large">
                        <i data-lucide="calculator"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ö‡∏¥‡∏•
                    </button>
                </div>
            </section>

            <!-- Settings -->
            <section id="settings" class="page">
                <header class="page-header">
                    <h1>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h1>
                </header>

                <div id="pwa-install-container" class="install-banner">
                    <i data-lucide="download" class="bg-icon"></i>
                    <h4>‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡∏•‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</h4>
                    <p>‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</p>
                    <button id="btn-pwa-install" class="btn-install-now">
                        <i data-lucide="plus-circle"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                    </button>
                </div>

                <div class="settings-card">
                    <div class="form-group">
                        <label><i data-lucide="palette"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏µ‡πÅ‡∏≠‡∏õ (‡∏ò‡∏µ‡∏°)</label>
                        <div class="theme-selector">
                            <button onclick="setTheme('light')" class="theme-btn" id="theme-light">
                                <i data-lucide="sun"></i>
                                <span>‡∏™‡∏ß‡πà‡∏≤‡∏á</span>
                            </button>
                            <button onclick="setTheme('dark')" class="theme-btn" id="theme-dark">
                                <i data-lucide="moon"></i>
                                <span>‡∏°‡∏∑‡∏î</span>
                            </button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top:20px;">
                        <label><i data-lucide="zap"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                        <div class="input-pair" style="margin-top:10px;">
                            <div class="input-container">
                                <label>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢)</label>
                                <input type="number" id="setting-elec-price" placeholder="7" onchange="saveSettings()">
                            </div>
                            <div class="input-container">
                                <label>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ (‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢)</label>
                                <input type="number" id="setting-water-price" placeholder="18"
                                    onchange="saveSettings()">
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top:20px;">
                        <label><i data-lucide="qr-code"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå)</label>
                        <div style="display:flex; flex-direction:column; gap:10px; margin-top:5px;">
                            <input type="text" id="setting-promptpay" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô"
                                onchange="saveSettings()">
                            <input type="text" id="setting-promptpay-name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"
                                onchange="saveSettings()">
                        </div>
                        <small style="color:var(--text-muted); font-size:0.75rem; margin-top:5px; display:block;">*
                            ‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡πÉ‡∏ö‡∏ö‡∏¥‡∏•</small>
                    </div>
                    <div class="form-group" style="margin-top:20px;">
                        <label><i data-lucide="table"></i> Google Sheets URL (‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå)</label>
                        <input type="url" id="sheets-url" placeholder="https://docs.google.com/spreadsheets/d/..."
                            onchange="saveSettings()">
                    </div>
                    <div class="form-group" style="margin-top:20px;">
                        <label><i data-lucide="cloud"></i> Google Web App URL (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</label>
                        <input type="url" id="google-url" placeholder="https://script.google.com/macros/s/..."
                            onchange="saveSettings()">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button id="sync-btn" onclick="syncData()" class="btn-primary-large" style="flex:1;">
                            <i data-lucide="upload-cloud" id="sync-icon"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Cloud
                        </button>
                        <button id="restore-btn" onclick="restoreData()" class="btn-primary-large"
                            style="flex:1; background:var(--success);">
                            <i data-lucide="download-cloud" id="restore-icon"></i> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cloud
                        </button>
                    </div>
                    <div id="sync-status" class="sync-status"></div>
                </div>
            </section>
        </main>

        <!-- Modals -->
        <div id="receipt-modal" class="modal">
            <div class="modal-content">
                <div id="receipt-content" class="receipt-card"></div>
                <div class="modal-actions" id="modal-actions-container">
                    <button onclick="saveAsImage()" class="btn-receipt-action"><i data-lucide="share-2"></i> ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ
                        (PNG)</button>
                    <button onclick="loadTransactionForEdit()" id="edit-bill-btn" class="btn-receipt-action"
                        style="background:var(--secondary); color:var(--text-main);"><i data-lucide="edit-3"></i>
                        ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button onclick="closeModal()" class="btn-receipt-action"
                        style="background:rgba(239, 68, 68, 0.1); color:var(--danger);"><i data-lucide="x"></i>
                        ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>

        <!-- Edit/Add Room Modal -->
        <div id="edit-modal" class="modal">
            <div class="modal-content" style="padding: 24px;">
                <h3 id="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á</h3><br>
                <input type="hidden" id="edit-room-index">
                <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á</label><input type="text" id="edit-room-id"
                        placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: A101"></div>
                <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</label><input type="text" id="edit-name"
                        placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
                <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="edit-phone"
                        placeholder="08x-xxx-xxxx"></div>
                <div class="form-group"><label>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="text" id="edit-price"
                        placeholder="4,500" oninput="formatMoneyInput(this)" inputmode="numeric"></div>
                <div class="modal-actions" style="background:none; padding:0; flex-direction:column;">
                    <button onclick="saveRoom()" class="btn-primary-large"
                        style="padding:15px; margin-bottom:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <div style="display:flex; gap:10px; width:100%;">
                        <button onclick="closeEditModal()" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button id="delete-btn" onclick="confirmDelete()" class="btn-danger"
                            style="display:none;">‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Meter History Modal -->
        <div id="history-modal" class="modal">
            <div class="modal-content" style="padding: 24px; max-width: 450px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h3 id="history-modal-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</h3>
                    <button onclick="closeHistoryModal()"
                        style="border:none; background:none; color:var(--text-muted); cursor:pointer;">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div id="history-container" style="max-height: 400px; overflow-y: auto;">
                    <!-- Data will be injected here -->
                </div>
                <div class="modal-actions" style="background:none; padding:15px 0 0 0;">
                    <button onclick="closeHistoryModal()" class="btn-primary-large"
                        style="padding:15px;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                </div>
            </div>
        </div>

        <!-- Camera Modal for OCR -->
        <div id="camera-modal" class="modal">
            <div class="modal-content" style="padding: 24px; max-width: 450px;">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i data-lucide="camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
                </h3>

                <div class="camera-container">
                    <video id="camera-video" autoplay playsinline></video>
                    <div class="camera-overlay"></div>
                    <div id="ocr-loader" class="ocr-loading">
                        <i data-lucide="refresh-cw" class="spinning"
                            style="width: 40px; height: 40px; margin-bottom: 10px;"></i>
                        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç...</p>
                    </div>
                </div>

                <div class="camera-actions">
                    <button onclick="captureAndOCR()" class="btn-capture">
                        <i data-lucide="scan-line"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏™‡πÅ‡∏Å‡∏ô
                    </button>
                    <button onclick="closeCamera()" class="btn-secondary" style="flex: 1;">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>

                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 15px; text-align: center;">
                    ‡πÄ‡∏•‡πá‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö
                </p>
            </div>
            <canvas id="camera-canvas" style="display: none;"></canvas>
        </div>
    </div>

    <!-- Bottom Nav - ‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ô‡∏≠‡∏Å Container ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Fixed ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -->
    <nav class="bottom-nav">
        <a href="javascript:void(0)" class="nav-item active" onclick="showPage('dashboard')">
            <i data-lucide="layout-dashboard"></i><span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="showPage('rooms')">
            <i data-lucide="home"></i><span>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="showPage('billing')">
            <i data-lucide="receipt"></i><span>‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="showPage('settings')">
            <i data-lucide="settings"></i><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
        </a>
    </nav>

    <script>
        // --- Data ---
        let rooms = JSON.parse(localStorage.getItem('rooms_data')) || [
            { id: 'A101', status: 'occupied', price: 4500, tenant: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏£‡∏±‡∏Å‡∏î‡∏µ', phone: '081-xxx-xxxx', lastElec: 1200, lastWater: 450 },
            { id: 'A102', status: 'vacant', price: 4500, tenant: '-', phone: '', lastElec: 800, lastWater: 300 },
            { id: 'A103', status: 'occupied', price: 4800, tenant: '‡∏ô‡∏†‡∏≤ ‡πÉ‡∏à‡∏ö‡∏∏‡∏ç', phone: '089-xxx-xxxx', lastElec: 1500, lastWater: 520 }
        ];

        let transactions = JSON.parse(localStorage.getItem('transactions_data')) || [
            { id: Date.now(), room: 'A101', amount: 4500, date: '20 ‡∏°.‡∏Ñ. 69' },
            { id: Date.now() + 1, room: 'A103', amount: 4800, date: '19 ‡∏°.‡∏Ñ. 69' }
        ];

        let editMode = 'edit'; // 'edit' or 'add'
        let editingTransactionId = null; // null = new bill, else = ID of transaction being edited

        // --- Core ---
        function saveToLocal() {
            localStorage.setItem('rooms_data', JSON.stringify(rooms));
            localStorage.setItem('transactions_data', JSON.stringify(transactions));
            // ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏°‡∏µ URL
            autoSyncData();
        }

        let syncTimeout;
        function autoSyncData() {
            const url = localStorage.getItem('google_url');
            if (!url) return;

            clearTimeout(syncTimeout);
            syncTimeout = setTimeout(() => {
                syncData(true); // true = auto mode (silent)
            }, 2000); // ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(id);
            if (target) target.classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navLink = document.querySelector(`[onclick="showPage('${id}')"]`);
            if (navLink) navLink.classList.add('active');

            if (id === 'rooms') renderRooms();
            if (id === 'billing') renderBilling();
            if (id === 'dashboard') renderDashboard();
            if (id === 'settings') {
                loadSettings();
            }
        }

        function saveSettings() {
            localStorage.setItem('elec_price', document.getElementById('setting-elec-price').value);
            localStorage.setItem('water_price', document.getElementById('setting-water-price').value);
            localStorage.setItem('google_url', document.getElementById('google-url').value);
            localStorage.setItem('sheets_url', document.getElementById('sheets-url').value);
            localStorage.setItem('promptpay_id', document.getElementById('setting-promptpay').value);
            localStorage.setItem('promptpay_name', document.getElementById('setting-promptpay-name').value);
        }

        function loadSettings() {
            document.getElementById('setting-elec-price').value = localStorage.getItem('elec_price') || 7;
            document.getElementById('setting-water-price').value = localStorage.getItem('water_price') || 18;
            document.getElementById('google-url').value = localStorage.getItem('google_url') || '';
            document.getElementById('sheets-url').value = localStorage.getItem('sheets_url') || '';
            document.getElementById('setting-promptpay').value = localStorage.getItem('promptpay_id') || '';
            document.getElementById('setting-promptpay-name').value = localStorage.getItem('promptpay_name') || '';
        }

        function openGoogleSheets() {
            const url = localStorage.getItem('sheets_url');
            if (url) {
                window.open(url, '_blank');
            } else {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheets ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö‡∏•‡∏∏‡∏á');
                showPage('settings');
            }
        }

        function renderDashboard() {
            const container = document.getElementById('recent-transactions');
            if (!container) return;
            container.innerHTML = transactions.slice().reverse().map((t, index) => {
                const originalIndex = transactions.length - 1 - index;
                const isPaid = t.status === 'paid';
                return `
                <div class="transaction-item" onclick="viewDetail(${originalIndex})" style="cursor:pointer; position:relative;">
                    <div class="icon-box" style="background:${isPaid ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)'}; color:${isPaid ? 'var(--success)' : 'var(--danger)'}">
                        <i data-lucide="${isPaid ? 'check-circle' : 'receipt'}"></i>
                    </div>
                    <div class="item-info">
                        <h4>‡∏´‡πâ‡∏≠‡∏á ${t.room}</h4>
                        <p>${t.date}</p>
                        <span class="status-badge ${isPaid ? 'status-paid' : 'status-unpaid'}">
                            ${isPaid ? '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}
                        </span>
                    </div>
                    <div class="item-amount" style="display:flex; align-items:center; gap:10px;">
                        <span class="price">‡∏ø${t.amount.toLocaleString()}</span>
                        <button onclick="event.stopPropagation(); deleteTransaction(${originalIndex})" style="border:none; background:rgba(239, 68, 68, 0.1); color:var(--danger); padding:5px; border-radius:8px;"><i data-lucide="trash-2" style="width:14px"></i></button>
                    </div>
                </div>
            `}).join('');

            const totalIncome = transactions.filter(t => t.status === 'paid').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalPending = transactions.filter(t => t.status !== 'paid').reduce((sum, t) => sum + (t.amount || 0), 0);

            document.getElementById('stat-income').innerText = `‡∏ø${totalIncome.toLocaleString()}`;
            document.getElementById('stat-pending').innerText = `‡∏ø${totalPending.toLocaleString()}`;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏•‡∏∏‡∏á)
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const monthlyIncome = transactions.reduce((sum, t) => {
                const tDate = t.rawDate ? new Date(t.rawDate) : null;
                if (tDate && tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) {
                    return sum + (t.amount || 0);
                }
                return sum;
            }, 0);

            const statMonthly = document.getElementById('stat-monthly');
            if (statMonthly) statMonthly.innerText = `‡∏ø${monthlyIncome.toLocaleString()}`;

            lucide.createIcons();
        }

        function deleteTransaction(index) {
            if (confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?')) {
                transactions.splice(index, 1);
                saveToLocal();
                renderDashboard();
            }
        }

        let currentViewIndex = null;
        function viewDetail(index) {
            currentViewIndex = index;
            const t = transactions[index];
            if (!t.details) {
                alert('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏±‡∏ö (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤)');
                return;
            }

            const ppIdRaw = localStorage.getItem('promptpay_id') || '';
            const ppId = ppIdRaw.replace(/[^0-9]/g, '');
            const ppName = localStorage.getItem('promptpay_name') || '';

            let qrHtml = '';
            if (ppId && ppId.length >= 10) {
                qrHtml = `
                    <div style="text-align:center; margin-top:20px; padding-top:20px; border-top:1px dashed #eee;">
                        <p style="font-size:0.8rem; color:var(--primary); font-weight:700; margin-bottom:5px;">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (PromptPay)</p>
                        ${ppName ? `<p style="font-size:0.9rem; font-weight:800; color:var(--text-main); margin-bottom:8px;">${ppName}</p>` : ''}
                        <canvas id="qr-canvas" style="margin:0 auto; background:#fff; padding:10px; border-radius:12px; border:1px solid #eee;"></canvas>
                        <p style="font-size:0.7rem; color:#64748b; margin-top:8px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤: ${t.details.tenant}</p>
                    </div>
                `;
            } else {
                qrHtml = `<p style="text-align:center; font-size:0.75rem; color:var(--danger); margin-top:15px; padding:10px; border:1px dashed var(--danger); border-radius:10px;">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (10 ‡∏´‡∏£‡∏∑‡∏≠ 13 ‡∏´‡∏•‡∏±‡∏Å)</p>`;
            }

            document.getElementById('receipt-content').innerHTML = `
                <div class="receipt-header" style="position:relative;">
                    ${t.status === 'paid' ? '<div style="position:absolute; top:0; right:0; border:3px solid #10b981; color:#10b981; padding:5px 10px; border-radius:8px; font-weight:900; transform:rotate(15deg); opacity:0.8;">PAID / ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>' : ''}
                    <h2>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</h2>
                    <p>‡∏´‡πâ‡∏≠‡∏á ${t.room}</p>
                    <small>${t.date}</small>
                </div>
                <div class="receipt-row"><span>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</span><span>${t.details.tenant}</span></div>
                <div class="receipt-row"><span>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á</span><span>‡∏ø${t.details.base.toLocaleString()}</span></div>
                <div class="receipt-row"><span>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (${t.details.eUnits} ‡∏´‡∏ô‡πà‡∏ß‡∏¢)</span><span>‡∏ø${t.details.ePrice.toLocaleString()}</span></div>
                <div class="receipt-row"><span>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ (${t.details.wUnits} ‡∏´‡∏ô‡πà‡∏ß‡∏¢)</span><span>‡∏ø${t.details.wPrice.toLocaleString()}</span></div>
                <div class="receipt-total"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span>‡∏ø${t.amount.toLocaleString()}</span></div>
                ${t.status === 'paid' ? '' : qrHtml}
                <p style="text-align:center; margin-top:20px; font-size:0.8rem; color:#64748b;">(‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ö‡∏¥‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</p>
            `;

            const isPaid = t.status === 'paid';
            document.getElementById('modal-actions-container').innerHTML = `
                <button onclick="togglePaymentStatus(${index})" class="btn-receipt-action" style="background:${isPaid ? '#64748b' : '#10b981'};">
                    <i data-lucide="${isPaid ? 'refresh-cw' : 'check-circle'}"></i> 
                    ${isPaid ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô'}
                </button>
                <button onclick="saveAsImage()" class="btn-receipt-action"><i data-lucide="share-2"></i> ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ (PNG)</button>
                <button onclick="loadTransactionForEdit()" id="edit-bill-btn" class="btn-receipt-action" style="background:var(--secondary); color:var(--text-main);"><i data-lucide="edit-3"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button onclick="closeModal()" class="btn-receipt-action" style="background:rgba(239, 68, 68, 0.1); color:var(--danger);"><i data-lucide="x"></i> ‡∏õ‡∏¥‡∏î</button>
            `;

            if (ppId && ppId.length >= 10) {
                const amount = Number(t.amount).toFixed(2);
                const qrPayload = generatePromptPayPayload(ppId, amount);
                new QRious({
                    element: document.getElementById('qr-canvas'),
                    value: qrPayload,
                    size: 180,
                    level: 'H'
                });
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏ï‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà‡πÜ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ)
            document.getElementById('edit-bill-btn').style.display = 'block';
            document.getElementById('receipt-modal').classList.add('active');
        }

        function loadTransactionForEdit() {
            if (currentViewIndex === null) return;
            const t = transactions[currentViewIndex];

            editingTransactionId = t.id;
            closeModal();
            showPage('billing');

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤
            document.getElementById('billing-title').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•‡∏´‡πâ‡∏≠‡∏á ' + t.room;
            document.getElementById('cancel-edit-btn').style.display = 'block';

            // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('bill-room-select').value = t.room;
            document.getElementById('base-rent').value = t.details.base.toLocaleString();

            // ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡πÜ ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô Units 
            // ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏Å‡πá‡∏ï‡∏≤‡∏° t.details ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö elec-prev, elec-curr... ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô t.details ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
            // ‡πÅ‡∏ï‡πà ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á calculateBill ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢

            // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô calculateBill (‡∏à‡∏∞‡πÅ‡∏Å‡πâ calculateBill ‡∏ï‡πà‡∏≠‡πÑ‡∏õ)
            if (t.details.meters) {
                document.getElementById('elec-prev').value = t.details.meters.ep;
                document.getElementById('elec-curr').value = t.details.meters.ec;
                document.getElementById('water-prev').value = t.details.meters.wp;
                document.getElementById('water-curr').value = t.details.meters.wc;
            }

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å "20 ‡∏°.‡∏Ñ. 69" ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "2026-01-20" ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡∏≤‡∏Å 
            // ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö rawDate ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢
            if (t.rawDate) {
                document.getElementById('bill-date').value = t.rawDate;
            }
        }

        function cancelEditBill() {
            editingTransactionId = null;
            document.getElementById('billing-title').innerText = '‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            renderBilling();
        }

        function renderRooms() {
            const container = document.getElementById('room-list');
            if (!container) return;
            container.innerHTML = rooms.map((r, index) => `
                <div class="room-card ${r.status}">
                    <div style="display:flex; justify-content:space-between; align-items: flex-start; margin-bottom:15px;">
                        <div>
                            <h4 style="font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-bottom: 4px;">‡∏´‡πâ‡∏≠‡∏á ${r.id}</h4>
                            <div style="display:flex; align-items:center; gap:6px;">
                                <span class="room-tag ${r.status}" style="font-size: 0.65rem;">
                                    ${r.status === 'occupied' ? '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤' : '‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á'}
                                </span>
                                <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">
                                    ${r.tenant === '-' ? '‡∏ß‡πà‡∏≤‡∏á' : r.tenant}
                                </span>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="viewMeterHistory('${r.id}')" title="‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå" 
                                style="width: 42px; height: 42px; border:none; background:rgba(99, 102, 241, 0.1); border-radius:14px; color:var(--primary); display:flex; align-items:center; justify-content:center; cursor:pointer;">
                                <i data-lucide="gauge" style="width:20px"></i>
                            </button>
                            <button onclick="openEdit(${index})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á"
                                style="width: 42px; height: 42px; border:none; background:var(--bg-app); border-radius:14px; color:var(--primary); display:flex; align-items:center; justify-content:center; cursor:pointer;">
                                <i data-lucide="edit-3" style="width:18px"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-top:15px; border-top: 1px dashed var(--border-color);">
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                            <span style="font-size: 1.25rem; font-weight: 800; color: var(--primary);">‡∏ø${r.price.toLocaleString()}</span>
                        </div>
                        <button onclick="document.getElementById('bill-room-select').value='${r.id}'; showPage('billing');" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 0.85rem; display: flex; align-items:center; gap:8px; cursor:pointer; box-shadow: var(--shadow-premium);">
                            <i data-lucide="receipt" style="width:16px"></i> ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderBilling() {
            const select = document.getElementById('bill-room-select');
            if (!select) return;
            select.innerHTML = rooms.map(r => `<option value="${r.id}">${r.id} - ${r.tenant}</option>`).join('');

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bill-date').value = today;

            updateBaseRent();
        }

        function updateBaseRent() {
            const selectValue = document.getElementById('bill-room-select').value;
            const room = rooms.find(r => r.id === selectValue);
            if (room) {
                document.getElementById('base-rent').value = room.price;
                document.getElementById('elec-prev').value = room.lastElec || 0;
                document.getElementById('water-prev').value = room.lastWater || 0;
                document.getElementById('elec-curr').value = '';
                document.getElementById('water-curr').value = '';
            }
        }

        function updateBaseRent() {
            const selectValue = document.getElementById('bill-room-select').value;
            const room = rooms.find(r => r.id === selectValue);
            if (room) {
                const rentInput = document.getElementById('base-rent');
                rentInput.value = (room.price || 0).toLocaleString();
                document.getElementById('elec-prev').value = room.lastElec || 0;
                document.getElementById('water-prev').value = room.lastWater || 0;
                document.getElementById('elec-curr').value = '';
                document.getElementById('water-curr').value = '';
            }
        }

        function formatMoneyInput(input) {
            let value = input.value.replace(/,/g, '');
            if (!isNaN(value) && value !== '') {
                input.value = parseFloat(value).toLocaleString();
            } else {
                input.value = value.replace(/[^0-9]/g, '');
            }
        }

        function stripCommas(str) {
            return parseFloat(str.replace(/,/g, '')) || 0;
        }

        function calculateBill() {
            const roomId = document.getElementById('bill-room-select').value;
            const room = rooms.find(r => r.id === roomId);
            const base = stripCommas(document.getElementById('base-rent').value);
            const ep = parseFloat(document.getElementById('elec-prev').value) || 0;
            const ec = parseFloat(document.getElementById('elec-curr').value) || 0;
            const wp = parseFloat(document.getElementById('water-prev').value) || 0;
            const wc = parseFloat(document.getElementById('water-curr').value) || 0;

            const elecRate = parseFloat(localStorage.getItem('elec_price')) || 7;
            const waterRate = parseFloat(localStorage.getItem('water_price')) || 18;

            const ePrice = Math.max(0, ec - ep) * elecRate;
            const wPrice = Math.max(0, wc - wp) * waterRate;
            const total = base + ePrice + wPrice;

            room.lastElec = ec;
            room.lastWater = wc;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÅ‡∏•‡∏∞‡∏õ‡∏µ ‡∏û.‡∏®. 2 ‡∏´‡∏•‡∏±‡∏Å
            const rawDate = document.getElementById('bill-date').value;
            const selectedDate = new Date(rawDate);
            const thaiYear = (selectedDate.getFullYear() + 543).toString().slice(-2);
            const dateStr = `${selectedDate.getDate()} ${['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'][selectedDate.getMonth()]} ${thaiYear}`;

            const transactionData = {
                id: editingTransactionId || Date.now(),
                room: roomId,
                amount: total,
                date: dateStr,
                rawDate: rawDate,
                details: {
                    tenant: room.tenant,
                    base: base,
                    eUnits: Math.max(0, ec - ep),
                    ePrice: ePrice,
                    wUnits: Math.max(0, wc - wp),
                    wPrice: wPrice,
                    meters: { ep, ec, wp, wc } // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                },
                status: editingTransactionId ? (transactions.find(t => t.id === editingTransactionId)?.status || 'unpaid') : 'unpaid'
            };

            if (editingTransactionId) {
                const idx = transactions.findIndex(t => t.id === editingTransactionId);
                if (idx !== -1) transactions[idx] = transactionData;
                cancelEditBill(); // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            } else {
                transactions.push(transactionData);
            }

            saveToLocal();
            renderDashboard();

            const ppIdRaw = localStorage.getItem('promptpay_id') || '';
            const ppId = ppIdRaw.replace(/[^0-9]/g, '');
            const ppName = localStorage.getItem('promptpay_name') || '';

            let qrHtml = '';
            if (ppId && ppId.length >= 10) {
                qrHtml = `
                    <div style="text-align:center; margin-top:20px; padding-top:20px; border-top:1px dashed #eee;">
                        <p style="font-size:0.8rem; color:var(--primary); font-weight:700; margin-bottom:5px;">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (PromptPay)</p>
                        ${ppName ? `<p style="font-size:0.9rem; font-weight:800; color:var(--text-main); margin-bottom:8px;">${ppName}</p>` : ''}
                        <canvas id="qr-canvas-new" style="margin:0 auto; background:#fff; padding:10px; border-radius:12px; border:1px solid #eee;"></canvas>
                        <p style="font-size:0.7rem; color:#64748b; margin-top:8px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤: ${room.tenant}</p>
                    </div>
                `;
            } else {
                qrHtml = `<p style="text-align:center; font-size:0.75rem; color:var(--danger); margin-top:15px; padding:10px; border:1px dashed var(--danger); border-radius:10px;">‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡∏£‡∏π‡∏õ QR ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö</p>`;
            }

            document.getElementById('receipt-content').innerHTML = `
                <div class="receipt-header"><h2>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</h2><p>‡∏´‡πâ‡∏≠‡∏á ${roomId}</p><small>${dateStr}</small></div>
                <div class="receipt-row"><span>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</span><span>${room.tenant}</span></div>
                <div class="receipt-row"><span>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á</span><span>‡∏ø${base.toLocaleString()}</span></div>
                <div class="receipt-row"><span>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (${Math.max(0, ec - ep)} ‡∏´‡∏ô‡πà‡∏ß‡∏¢)</span><span>‡∏ø${ePrice.toLocaleString()}</span></div>
                <div class="receipt-row"><span>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ (${Math.max(0, wc - wp)} ‡∏´‡∏ô‡πà‡∏ß‡∏¢)</span><span>‡∏ø${wPrice.toLocaleString()}</span></div>
                <div class="receipt-total"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span>‡∏ø${total.toLocaleString()}</span></div>
                ${qrHtml}
                <p style="text-align:center; margin-top:20px; font-size:0.8rem; color:#64748b;">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö üôè</p>
            `;

            if (ppId && ppId.length >= 10) {
                const amount = Number(total).toFixed(2);
                const qrPayload = generatePromptPayPayload(ppId, amount);
                new QRious({
                    element: document.getElementById('qr-canvas-new'),
                    value: qrPayload,
                    size: 180,
                    level: 'H'
                });
            }
            document.getElementById('modal-actions-container').innerHTML = `
                <button onclick="togglePaymentStatus(${transactions.length - 1})" class="btn-receipt-action" style="background:#10b981;">
                    <i data-lucide="check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
                </button>
                <button onclick="saveAsImage()" class="btn-receipt-action"><i data-lucide="share-2"></i> ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ (PNG)</button>
                <button onclick="closeModal()" class="btn-receipt-action" style="background:rgba(239, 68, 68, 0.1); color:var(--danger);"><i data-lucide="x"></i> ‡∏õ‡∏¥‡∏î</button>
            `;
            document.getElementById('receipt-modal').classList.add('active');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö CRC16 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á)
        function crc16(data) {
            let crc = 0xFFFF;
            for (let i = 0; i < data.length; i++) {
                let x = ((crc >> 8) ^ data.charCodeAt(i)) & 0xFF;
                x ^= x >> 4;
                crc = ((crc << 8) ^ (x << 12) ^ (x << 5) ^ (x)) & 0xFFFF;
            }
            return crc.toString(16).toUpperCase().padStart(4, '0');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ Payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
        function generatePromptPayPayload(ppId, amount) {
            const cleanId = ppId.replace(/[^0-9]/g, '');
            const target = cleanId.length === 13 ? cleanId : ("0066" + cleanId.slice(1)).slice(-13);
            const amountStr = parseFloat(amount).toFixed(2);

            let payload = "000201010212";
            const idField = cleanId.length === 13 ? "0213" + cleanId : "0113" + target;
            payload += "2937" + "0016A000000677010111" + idField;
            payload += "5802TH";
            payload += "5303764";

            if (parseFloat(amount) > 0) {
                const tag54 = "54" + amountStr.length.toString().padStart(2, '0') + amountStr;
                payload += tag54;
            }

            payload += "6304";
            payload += crc16(payload);

            return payload;
        }
        function openAddRoom() {
            editMode = 'add';
            document.getElementById('modal-title').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('edit-room-index').value = '';
            document.getElementById('edit-room-id').value = '';
            document.getElementById('edit-name').value = '';
            document.getElementById('edit-phone').value = '';
            document.getElementById('edit-price').value = '4500';
            document.getElementById('delete-btn').style.display = 'none';
            document.getElementById('edit-modal').classList.add('active');
        }

        function openEdit(index) {
            editMode = 'edit';
            const room = rooms[index];
            document.getElementById('modal-title').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á';
            document.getElementById('edit-room-index').value = index;
            document.getElementById('edit-room-id').value = room.id;
            document.getElementById('edit-name').value = room.tenant === '-' ? '' : room.tenant;
            document.getElementById('edit-phone').value = room.phone;
            document.getElementById('edit-price').value = (room.price || 0).toLocaleString();
            document.getElementById('delete-btn').style.display = 'block';
            document.getElementById('edit-modal').classList.add('active');
        }

        function saveRoom() {
            const id = document.getElementById('edit-room-id').value.trim();
            if (!id) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö'); return; }

            const tenant = document.getElementById('edit-name').value.trim() || '-';
            const phone = document.getElementById('edit-phone').value.trim();
            const price = stripCommas(document.getElementById('edit-price').value);
            const status = tenant !== '-' ? 'occupied' : 'vacant';

            if (editMode === 'add') {
                rooms.push({
                    id: id,
                    status: status,
                    price: price,
                    tenant: tenant,
                    phone: phone,
                    lastElec: 0,
                    lastWater: 0
                });
            } else {
                const index = document.getElementById('edit-room-index').value;
                rooms[index].id = id;
                rooms[index].tenant = tenant;
                rooms[index].phone = phone;
                rooms[index].price = price;
                rooms[index].status = status;
            }

            saveToLocal();
            renderRooms();
            closeEditModal();
        }

        function confirmDelete() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏•‡∏∏‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ñ‡∏≤‡∏ß‡∏£‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö')) {
                const index = document.getElementById('edit-room-index').value;
                rooms.splice(index, 1);
                saveToLocal();
                renderRooms();
                closeEditModal();
            }
        }

        async function saveAsImage() {
            const btn = event.currentTarget;
            const originalText = btn.innerText;
            try {
                btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                btn.disabled = true;

                const receipt = document.getElementById('receipt-content');

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ canvas
                const canvas = await html2canvas(receipt, {
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--modal-bg'),
                    scale: 3, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á
                    logging: false,
                    useCORS: true,
                    borderRadius: 32
                });

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                const link = document.createElement('a');
                const roomId = receipt.querySelector('p')?.innerText.replace('‡∏´‡πâ‡∏≠‡∏á ', '') || 'bill';
                link.download = `Bill-${roomId}-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                btn.innerText = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Save image error:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function syncData(isAuto = false) {
            const url = isAuto ? localStorage.getItem('google_url') : document.getElementById('google-url').value;
            const btn = document.getElementById('sync-btn');
            const icon = document.getElementById('sync-icon');
            const status = document.getElementById('sync-status');

            if (!url) {
                if (!isAuto) alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Google Web App URL ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
                return;
            }

            try {
                if (btn) btn.disabled = true;
                if (icon) icon.classList.add('spinning');
                if (status) {
                    status.innerText = isAuto ? 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                    status.style.color = 'var(--text-main)';
                }

                const appData = { rooms: rooms, transactions: transactions };
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appData)
                });

                if (status) {
                    status.innerText = isAuto ? '‚úÖ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‚úÖ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!';
                    status.style.color = 'var(--success)';
                }
                localStorage.setItem('google_url', url);
            } catch (error) {
                console.error('Sync error:', error);
                if (status) {
                    status.innerText = '‚ùå ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏õ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
                    status.style.color = 'var(--danger)';
                }
            } finally {
                if (btn) btn.disabled = false;
                if (icon) icon.classList.remove('spinning');
            }
        }

        function togglePaymentStatus(index) {
            const t = transactions[index];
            t.status = t.status === 'paid' ? 'unpaid' : 'paid';
            saveToLocal();
            renderDashboard();
            viewDetail(index); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ
        }

        async function restoreData() {
            const url = document.getElementById('google-url').value;
            const btn = document.getElementById('restore-btn');
            const icon = document.getElementById('restore-icon');
            const status = document.getElementById('sync-status');

            if (!url) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Google Web App URL ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud ‡∏°‡∏≤‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏•‡∏∏‡∏á')) return;

            try {
                btn.disabled = true;
                if (icon) icon.classList.add('spinning');
                status.innerText = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud...';
                status.style.color = 'var(--text-main)';

                const response = await fetch(url + '?action=get');
                const data = await response.json();

                if (data && data.rooms && data.transactions) {
                    rooms = data.rooms;
                    transactions = data.transactions;
                    saveToLocal();
                    renderRooms();
                    renderDashboard();
                    status.innerText = '‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!';
                    status.style.color = 'var(--success)';
                    alert('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö‡∏•‡∏∏‡∏á! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏°‡∏à‡∏∞‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö');
                } else {
                    throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            } catch (error) {
                console.error('Restore error:', error);
                status.innerText = '‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠ Script)';
                status.style.color = 'var(--danger)';
                alert('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡∏ö‡∏•‡∏∏‡∏á ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏•‡∏∏‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô Google Script ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏°‡∏ö‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö');
            } finally {
                btn.disabled = false;
                if (icon) icon.classList.remove('spinning');
            }
        }

        function closeModal() { document.getElementById('receipt-modal').classList.remove('active'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }
        function closeHistoryModal() { document.getElementById('history-modal').classList.remove('active'); }

        function viewMeterHistory(roomId) {
            const container = document.getElementById('history-container');
            const roomTransactions = transactions.filter(t => t.room === roomId && t.details && t.details.meters).reverse();

            document.getElementById('history-modal-title').innerText = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡πâ‡∏≠‡∏á ${roomId}`;

            if (roomTransactions.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted);">
                    <i data-lucide="database-zap" style="width:40px; height:40px; margin-bottom:10px; opacity:0.3;"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏±‡∏ö</p>
                </div>`;
                document.getElementById('history-modal').classList.add('active');
                lucide.createIcons();
                return;
            }

            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‚ö° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</th>
                            <th>üíß ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            roomTransactions.forEach(t => {
                const m = t.details.meters;
                const eDiff = Math.max(0, m.ec - m.ep);
                const wDiff = Math.max(0, m.wc - m.wp);

                html += `
                    <tr class="history-row">
                        <td>
                            <div style="font-weight:600; color:var(--text-main);">${t.date}</div>
                            <div style="font-size:0.65rem; color:var(--text-muted);">‡∏ø${t.amount.toLocaleString()}</div>
                        </td>
                        <td>
                            <div class="meter-val">${m.ec.toLocaleString()}</div>
                            <div style="font-size:0.7rem; color:var(--text-muted); display:flex; align-items:center;">
                                <span>‡∏à‡∏î‡∏ó‡∏µ‡πà ${m.ep.toLocaleString()}</span>
                                <span class="meter-diff">+${eDiff}</span>
                            </div>
                        </td>
                        <td>
                            <div class="meter-val">${m.wc.toLocaleString()}</div>
                            <div style="font-size:0.7rem; color:var(--text-muted); display:flex; align-items:center;">
                                <span>‡∏à‡∏î‡∏ó‡∏µ‡πà ${m.wp.toLocaleString()}</span>
                                <span class="meter-diff">+${wDiff}</span>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
            document.getElementById('history-modal').classList.add('active');
            lucide.createIcons();
        }

        function setTheme(mode) {
            if (mode === 'dark') {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
            updateThemeUI();
        }

        function updateThemeUI() {
            const isDark = document.body.classList.contains('dark-mode');
            const lightBtn = document.getElementById('theme-light');
            const darkBtn = document.getElementById('theme-dark');
            if (lightBtn && darkBtn) {
                if (isDark) {
                    darkBtn.classList.add('active');
                    lightBtn.classList.remove('active');
                } else {
                    lightBtn.classList.add('active');
                    darkBtn.classList.remove('active');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
            loadSettings();
            updateThemeUI();
            renderDashboard();
            lucide.createIcons();

            // Register Service Worker for PWA with Update logic
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => {
                            console.log('Service Worker Registered');

                            // Check for updates periodically
                            reg.update();

                            reg.onupdatefound = () => {
                                const installingWorker = reg.installing;
                                installingWorker.onstatechange = () => {
                                    if (installingWorker.state === 'installed') {
                                        if (navigator.serviceWorker.controller) {
                                            // New content is available, show a message or just reload
                                            console.log('New content detected, updating...');
                                            if (confirm('‡∏û‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á)! ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö‡∏•‡∏∏‡∏á?')) {
                                                window.location.reload();
                                            }
                                        }
                                    }
                                };
                            };
                        })
                        .catch((err) => console.log('Service Worker Failed', err));
                });

                // Listen for controller change to reload page
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    refreshing = true;
                    window.location.reload();
                });
            }

            // PWA Install Logic
            let deferredPrompt;
            const installContainer = document.getElementById('pwa-install-container');
            const installBtn = document.getElementById('btn-pwa-install');

            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent Chrome 67 and earlier from automatically showing the prompt
                e.preventDefault();
                // Stash the event so it can be triggered later.
                deferredPrompt = e;
                // Update UI to notify the user they can add to home screen
                if (installContainer) installContainer.style.display = 'block';
            });

            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    // Show the prompt
                    deferredPrompt.prompt();
                    // Wait for the user to respond to the prompt
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User responded to the install prompt: ${outcome}`);
                    // We've used the prompt, and can't use it again, throw it away
                    deferredPrompt = null;
                    // Hide the install banner
                    if (installContainer) installContainer.style.display = 'none';
                });
            }

            window.addEventListener('appinstalled', () => {
                // Hide the app-provided install promotion
                if (installContainer) installContainer.style.display = 'none';
                console.log('PWA was installed');
            });
        });

        // --- Camera & OCR Logic ---
        let currentTargetInputId = '';
        let stream = null;

        async function openCamera(inputId) {
            currentTargetInputId = inputId;
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-video');

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                modal.classList.add('active');
                lucide.createIcons();
            } catch (err) {
                console.error("Error accessing camera:", err);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
            }
        }

        function closeCamera() {
            const modal = document.getElementById('camera-modal');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            modal.classList.remove('active');
        }

        async function captureAndOCR() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const loader = document.getElementById('ocr-loader');
            const ctx = canvas.getContext('2d');

            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Show loader
            loader.style.display = 'flex';

            try {
                // Perform OCR on the captured image
                // We crop the image to the overlay area for better accuracy if needed, 
                // but Tesseract is usually good enough with the full image or we can refine here.

                // Crop to center (simulating the overlay)
                const cropWidth = canvas.width * 0.7;
                const cropHeight = canvas.height * 0.4;
                const cropX = (canvas.width - cropWidth) / 2;
                const cropY = (canvas.height - cropHeight) / 2;

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = cropWidth;
                tempCanvas.height = cropHeight;
                tempCanvas.getContext('2d').drawImage(canvas, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

                const result = await Tesseract.recognize(
                    tempCanvas.toDataURL('image/jpeg'),
                    'eng', // Meters usually have standard digits
                    {
                        logger: m => console.log(m),
                        tessedit_char_whitelist: '0123456789' // Only look for numbers
                    }
                );

                const text = result.data.text.replace(/[^0-9]/g, '');

                if (text) {
                    const input = document.getElementById(currentTargetInputId);
                    input.value = text;
                    // Trigger input event for any listeners if they exist (though here we don't have many)
                    input.dispatchEvent(new Event('input'));

                    // Success feedback
                    setTimeout(() => {
                        loader.style.display = 'none';
                        closeCamera();
                    }, 500);
                } else {
                    alert('‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏•‡∏∏‡∏á');
                    loader.style.display = 'none';
                }
            } catch (error) {
                console.error("OCR Error:", error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏±‡∏ö');
                loader.style.display = 'none';
            }
        }
    </script>
</body>

</html>